---
- hosts:
  - mons
  - osds
  gather_facts: true
  become: yes

  ####################################################################
  ## NOTE!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! ##
  ## THIS IS USED TO SPEED UP TESTING. NEVER USE THIS IN PRODUCTION ##
  ####################################################################
  strategy: free
# serial: 1

  tasks:
    - block:
      - name: Upgrade all packages to the latest version
        apt:
          update_cache: yes
          upgrade: full

      - name: Ensure update-manager-core is installed
        apt:
          name: update-manager-core
          state: present

      - name: Run do-release-upgrade non-interactively
        command: do-release-upgrade -f DistUpgradeViewNonInteractive

      # This part is specific to Ceph monitors
      - name: Tasks specific to Ceph monitors
        include: upgrade-mons.yml
        when: "'mons' in group_names"

      - name: Reboot the server
        command: reboot
        async: 0
        poll: 0

      - name: Wait for server to reboot
        become: no
        wait_for:
          host: "{{ ansible_ssh_host }}"
          port: 22
          state: started
        connection: local

      when: ansible_distribution == 'Ubuntu' and ansible_distribution_release == 'trusty'
